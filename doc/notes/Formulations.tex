\documentclass[notes.tex]{subfiles}
 
\begin{document}

\section{SPH Formulation in FleCSPH}
Smoothed particle hydrodynamics (SPH) is an explicit numerical meshfree method
that solves partial differential equations (PDE) of hydrodynamics by
discretizing the flow with a set of fluid elements called particle. 
The main SPH formula to interpolate a quantity $A(\vec{r})$, which is
specified by its values on a set of particles $A_b \equiv A(\vec{r}_b)$, 
is as follows (Rosswog 2009):
\begin{equation}
A(\vec{r}) \simeq \sum_{b\in\Omega(\vec{r})} V_b A_b W(|\vec{r}-\vec{r}_b|,h)
\end{equation}
where $W$ is a smoothing kernel, 
$h$ is the smoothing length (hydro interaction range) at a position $\vec{r}$, 
and $V_b$ is a volume element, usually $V_b = m_b/\rho_b$.

In comparison with Eulerian methods, SPH has several advantages. It can easily
adapt to complex geometries, naturally handle low density regions, and does
not require low-density floor to handle vacuum. It conserves mass by
construction, and can be easily made to conserve linear momentum, angular
momentum, and energy up to roundoff. Another advantage of using SPH is its
exact advection of fluid properties. Furthermore, the same tree which is used
to find particle neighbors, can be employed for computing Newtonian
gravitational forces.

Shortcomings of SPH are its convergence which is restricted to low-order, 
and high sensitivity to the initial particles distribution. 
Also, SPH struggles with resolving turbulence-dominated flows and requires
special care when handling high gradients, such as shocks and stellar surface.

The starting point at a continuum limit is Euler ideal fluid equations in the
Lagrangian formulation, expressing conservation equations of mass and linear
momentum:
\begin{align}
\frac{d \rho}{d t} &= - \rho \nabla \cdot \vec{v}, \\
\frac{d u}{d t} &= \left( \frac{P}{\rho^2} \right) \frac{d \rho}{d t}, \\
\frac{d \vec{v}}{d t} &= - \frac{\nabla P}{\rho} + \vec{g}, \\
\end{align}
where $d/dt = \partial_t + \vec{v} \cdot \nabla$ and $\vec{g}$ is
a gravitational acceleration. The latter may be due to interparticle
gravitational interaction, an external gravitational field, or both.

\subsection{Basic formulation}
\label{sec:basic_formulation}

In its simplest form, SPH discretization uses the volume element 
$V_b = m_b / \rho_b$, a constant smoothing length $h$, and artificial
viscosity term $\Pi_{ab}$:
\begin{align}
  \rho_a &= \sum_b m_b W_{ab}, 
\\
  \frac{d u_a}{dt}  
      &= \sum_b m_b\left( 
           \frac{P_a}{\rho_a^2} + \frac12\Pi_{ab}
         \right)\vec{v}_{ab} \cdot \nabla_a W_{ab},
\\
  \frac{d \vec{v}_a}{d t} &= -\sum_b m_b 
      \left( \frac{P_a}{\rho_a^2} 
           + \frac{P_b}{\rho_b^2} 
           + \Pi_{ab} \right) \nabla_a W_{ab}
       + \vec{g}_a,
\end{align}
where $W_{ab} = W(|\vec{r}_a - \vec{r}_b|,h)$.
The viscous stress tensor $\Pi_{ab}$ may be defined in different ways;
currently we have adopted the following form:
\begin{equation}
\Pi_{ab} = 
\begin{cases}
  \frac{- \alpha \bar{c}_{ab} \mu_{ab} + \beta \mu_{ab}^2}{\bar{\rho}_{ab}} 
    & \text{for $\vec{r}_{ab} \cdot \vec{v}_{ab} < 0$,} \\
  0 & \text{otherwise,}
\end{cases}
\end{equation}
where the following quantities are defined: 
\begin{align}
  &\mu_{ab} = \frac{\bar{h}_{ab} \vec{r}_{ab} \cdot \vec{v}_{ab}}
                   {|\vec{r}_{ab}|^2 + \epsilon \bar{h}_{ab}^2},\\
  &\vec{r}_{ab} = \vec{r}_a - \vec{r}_b, &\vec{v}_{ab} = \vec{v}_a - \vec{v}_b,\\
  &\text{average speed of sound:} &\bar{c}_{ab} = (c_a + c_b)/2, \\
  &\text{average density:}        &\bar{\rho}_{ab} = (\rho_a + \rho_b)/2,\\
  &\text{average smoothing length:} &\bar{h}_{ab} = (h_a + h_b)/2,\\
\end{align}

In the basic formulation with a constant smoothing length, $\bar{h}_{ab}\equiv h$.
The values of $\epsilon$, $\alpha$, and $\beta$ control the strength and
application of artificial viscosity. Their default values:
$\epsilon = 0.01$, $\alpha = 1.0$, and $\beta = 2.0$.

The quantity $\bar{c}_{ab}$ is a speed of sound, averaged between particles
$a$ and $b$: $\bar{c}_{ab} = (c_a + c_b)/2$. It is computed as usual:
\begin{equation}
c_a = \sqrt{\left(\frac{\partial P}{\partial \rho}\right)_{S,a}},
\end{equation}
where the partial derivative is taken under constraint of a constant entropy
$S$, with thermodynamic conditions at particle $a$.
E.g., the following (Newton-Laplace) equation,
\begin{align}
  c_a = \sqrt{\frac{\Gamma P_a}{\rho_a}}
\end{align}
holds both for polytropic and ideal fluid equations of state (see
Section~\ref{sec:eos}).

If $\vec{g}=0$, then the basic formulation, when integrated with a symplectic
integrator, conserves energy, momentum and angular momentum \emph{exactly}
(e.g. Rosswog 2009, Section 2.4).

\end{document}
